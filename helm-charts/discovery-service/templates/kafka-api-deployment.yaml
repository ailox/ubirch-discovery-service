apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: "kafka-api-{{ template "discovery-service.fullname" . }}"
  namespace: {{ .Values.namespace }}
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  template:
    metadata:
      labels:
        app: responder-svc
        env: {{ .Values.environment }}
    spec:
      serviceAccountName: ingest
      containers:
        - name: responder-svc
          image: "ubirch/responder:{{ .Values.image.tag | default "latest" }}"
          imagePullPolicy: Always
          ports:
            - containerPort: 8080
            - containerPort: 9010
          resources:
            requests:
              cpu: 0.5
              memory: 0.3Gi
            limits:
              cpu: 1
              memory: 0.5Gi
          readinessProbe:
            tcpSocket:
              port: 9010
            initialDelaySeconds: 10
            periodSeconds: 10
          livenessProbe:
            tcpSocket:
              port: 9010
            initialDelaySeconds: 20
            periodSeconds: 60
          env:
            - name: DISC_ENV_KAFKA_CONS_BOOTSTRAP
              value: {{ .Values.discoveryservice.kafka.bootstrapServers }}
            - name: DISC_ENV_KAFKA_CONS_TOPIC
              value: {{ .Values.discoveryservice.kafka.consumer.topics }}
            - name: DISC_ENV_KAFKA_CONS_GROUPID
              value: {{ .Values.discoveryservice.kafka.consumer.group }}
            - name: DISC_ENV_KAFKA_CONS_ERRORTOPIC
              value: {{ .Values.discoveryservice.kafka.consumer.errorTopic }}
            - name: DISC_ENV_KAFKA_CONS_TIMEOUT
              value: {{ .Values.discoveryservice.kafka.timeout }}
            - name: DISC_ENV_KAFKA_CONS_POOLREC
              value: {{ .Values.discoveryservice.kafka.consumer.poolRecords }}
            - name: DISC_ENV_KAFKA_PROD_BOOTSTRAP
              value: {{ .Values.discoveryservice.kafka.bootstrapServers }}
            - name: DISC_ENV_KAFKA_PROD_ERRORTOPIC
              value: {{ .Values.discoveryservice.kafka.producer.errorTopic }}
            - name: DISC_ENV_KAFKA_PROD_TOPIC
              value: {{ .Values.discoveryservice.kafka.producer.topics }}
            - name: DISC_ENV_KAFKA_PROD_TIMEOUT
              value: {{ .Values.discoveryservice.kafka.timeout }}
            - name: DISC_ENV_KAFKA_PROMETHEUS
              value: {{ .Values.discoveryservice.prometheus.port }}
            - name: DISC_ENV_CORE_HOSTS
              value: {{ .Values.discoveryservice.core.hosts }}
            - name: DISC_ENV_CORE_PORT
              value: {{ .Values.discoveryservice.core.port }}
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
